# 10.멀티 프로세서 스케줄링 (고급)

다수의 CPU를 사용하는 멀티코어 기술을 어떻게 효율적으로 사용하는 방법 -> **쓰레드**를 이용하여 프로그램이 병렬로 실행하도록 작성
> 그렇다면 멀티코어 프로그램은 어떻게 스케줄링 되어야 하는가?

## 10.1 배경: 멀티프로세서 구조

- 하드웨어 캐시 계층: 프로그램을 빠르게 실행하기 위해 존재 - 메인 메모리에서 자주 사용되는 데이터의 복사본을 저장
  - 시간 지역성: 데이터에 한 번 접근하면 가까운 미래에 재접근하기 쉬움
  - 공간 지역성: 프로그램이 주소 x의 데이터를 접근하면 주소 x 주변의 데이터에 재접근하기 쉬움
 
-> 단일 CPU 시스템에서는 캐시 사용이 편리했지만, 멀티프로세서 시스템에서는 생각해야 할 부분이 더 많다.
- 캐시 일관성 문제: 변경한 데이터를 바로 메인 메모리에 저장하지 않으므로, 각 CPU들끼리 캐시에 갖고 있는 데이터가 다를 수 있다.
- 기본 해결책은 하드웨어가 메모리 주소를 감시하고 시스템을 관리하는 것으로, 특히 여러 개의 프로세스들이 하나의 메모리에 갱신할 때는 항상 공유되도록 함  
  - 버스 스누핑 (버스 기반 시스템에서 사용)
    1. 캐시는 자신과 메모리를 연결하는 버스의 통신 상황을 계속 모니터링
    2. 캐시 데이터에 대한 변경이 발생하면 자신의 복사본을 무효화 시키거나 갱신함
    - write-back 캐시에 대한 처리는 더 복잡하다.

## 10.2 동기화를 잊지 마시오

- 올바른 연산 결과 보장하기 위해 **lock-free** 데이터 구조 등의 동기화 기법이 사용된다.
  - 여러 개 CPU의 쓰레드가 동일한 공유 큐를 사용할 경우 등
- 하지만 성능(속도) 등 여러 문제가 발생하므로, lock을 남발해서 사용하지 말 것.

## 10.3 마지막 문제점: 캐시 친화성

- 실행될 때, 프로세스는 해당 CPU 캐시와 TLB에 상당량 정보를 탑재한다.
- 이후 동일한 메모리에서 실행되는 것이 성능에 유리하다는 개념이 **캐시 친화성**
- 멀티프로세서 스케줄러는 가능한 한 프로세스를 동일한 CPU에서 실행하려고 노력하는 방향으로 결정해야 한다.

## 10.4 단일 큐 스케줄링 (SQMS)

- 단일 프로세서 스케줄링의 기본 프레임워크를 그대로 사용하는 것

### 장점
- 단순함: 큐를 1개 사용하기 때문에 기존 정책에서 많은 변경이 불필요
### 단점
- 확장성 결여: lock을 통해 동기화 관리를 해야 하는데, 성능을 저하시킨다.
- 캐시 친화성: 각 CPU는 공유 큐에서 다음 작업을 선택하기 때문에 각 작업은 CPU를 옮겨다니게 된다.
  - **해결책**: 특정 작업들에 대해 캐시 친화성 고려하여 스케줄링하고 다른 작업들은 분산시킴 -> 구현이 복잡해질 수 있다.
 
## 10.5 멀티 큐 스케줄링 (MQMS)

- CPU마다 큐를 하나씩 두는 방식 (여러 개의 스케줄링 큐 사용): 각 큐는 특정 스케줄링 규칙을 따른다.
- 작업이 시스템에 들어가면 하나의 스케줄링 큐에 배치되며, 후에는 각각이 독립적으로 스케줄 된다.

### 장점
- 확장성: CPU 개수가 증가할수록 큐 개수도 증가하므로, lock과 cache contention 고려할 필요 없음.
- 캐시 친화적: 작업이 같은 CPU에서 계속 실행
### 문제점
- 워크로드 불균형(load imbalance)
  - 한쪽 큐의 작업이 다른 큐의 작업보다 빨리 끝났을 경우, 해당 큐는 작업을 하지 않는 문제
#### 해결책
- 이주(migration)
  - 작업을 다른 CPU로 이주시켜 워크로드 균형 달성
- 이주 필요 여부 결정
  - 작업 훔치기: 작업의 개수가 낮은 큐가 가끔 다른 큐에 훨씬 많은 수의 작업이 있는지 검사한 후 -> 대상에서 작업을 가져옴
  - 검사 오버헤드 vs 워크로드 불균형 사이 적절한 값 탐색 필요
 
## 10.6 Linux 멀티프로세서 스케줄러
- O(1) 스케줄러, Completely Fair Scheduler(CFS), BF 스케줄러(BFS) 사용
- O(1)과 CFS는 멀티 큐, BFS는 단일 큐
- O(1)은 우선순위 기반 스케줄러(MLFQ와 유사), CFS는 결정론적 비례배분 방식, BFS는 비례배분 방식
